name: Build Linux Deb Package

on: # cuando se lanza
  push:
    tags:  # cuando se crea un nuevo tag con el formato v*
      - 'v*'
  workflow_dispatch:  # manual

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v3
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Obtener versión
      id: version
      run: |
        VERSION=$(python3 -c "from manifest import __version__; print(__version__)")
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Versión detectada: $VERSION"
    
    - name: Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          dpkg-dev \
          fakeroot \
          libxcb-cursor0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xinerama0 \
          libxcb-xfixes0 \
          upx-ucl
    
    - name: Instalar dependencias de Python
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -r requirements.txt
    
    - name: Compilar y crear paquete .deb
      run: |
        cd build
        python3 build_deb.py
        cd ..
        mv maya-signer_*.deb .
    
    - name: Verificar paquete
      run: |
        ls -lh *.deb
        dpkg-deb --info *.deb
    
    - name: Subir artefacto
      uses: actions/upload-artifact@v3
      with:
        name: maya-signer-deb-v${{ steps.version.outputs.VERSION }}
        path: '*.deb'
        retention-days: 20
    
    - name: Crear Release (solo en tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: '*.deb'
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

